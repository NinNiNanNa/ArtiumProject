<?xml version="1.0" encoding="UTF-8"?>

<!-- 마이바티스 Doctype 설정 -->
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
	<mapper namespace="com.edu.springboot.gallery.IGalleryService">
	
	
		<select id="getTotalCount" resultType="int" parameterType="com.edu.springboot.gallery.ParameterDTO">
			SELECT COUNT(*) FROM gallery
			<if test="searchKeyword!=null and !searchKeyword.equals('')">
				WHERE ${searchField} LIKE '%'||#{searchKeyword}||'%'
			</if>
		</select>
		
		<select id="listPage" resultType="com.edu.springboot.gallery.GalleryDTO" parameterType="com.edu.springboot.gallery.ParameterDTO">
			SELECT * FROM (
				SELECT Tb.*, rownum rNum FROM (
					SELECT * FROM gallery
					<if test="searchKeyword!=null and !searchKeyword.equals('')">
						WHERE ${searchField} LIKE '%'||#{searchKeyword}||'%'
					</if>
					ORDER BY ga_id DESC
				) Tb
			)
			 WHERE rNum<![CDATA[>=]]>#{start} AND rNum<![CDATA[<=]]>#{end}
		</select>
		
		<insert id="write">
    insert into gallery (
        ga_id, ga_title, user_id, ga_sdate, ga_edate, ga_content,
        art_image1, art_title1, art_content1, art_image2, art_title2, art_content2, 
        art_image3, art_title3, art_content3, art_image4, art_title4, art_content4, 
        art_image5, art_title5, art_content5
    )
    values (
        seq_board_num.nextval, 
        #{ga_title}, 
        #{user_id}, 
        #{ga_sdate}, 
        #{ga_edate}, 
        #{ga_content},
        #{art_image1},
        #{art_title1}, 
        #{art_content1}, 
        #{art_image2}, 
        #{art_title2}, 
        #{art_content2},
        #{art_image3}, 
        #{art_title3}, 
        #{art_content3}, 
        #{art_image4}, 
        #{art_title4}, 
        #{art_content4},
        #{art_image5}, 
        #{art_title5}, 
        #{art_content5}
    );
		</insert>
		
		<select id="view" resultType="com.edu.springboot.gallery.GalleryDTO"
		parameterType="com.edu.springboot.gallery.GalleryDTO">
		SELECT * FROM gallery WHERE ga_id=#{ga_id}
		</select>
		
		<update id="visitCount" parameterType="com.edu.springboot.gallery.GalleryDTO">
			UPDATE gallery SET ga_visitcount=ga_visitcount+1 WHERE ga_id=#{ga_id}
		</update>
		
		 <!-- 갤러리 댓글 등록 -->
    <insert id="addGalleryComment" parameterType="com.edu.springboot.gallery.GalleryCommentDTO">
        INSERT INTO comments (cm_id, user_id, cm_content, cm_postdate)
        VALUES (#{cm_id}, #{user_id}, #{cm_content}, sysdate)
    </insert>

    <!-- 갤러리 댓글 목록 조회 -->
		<select id="getGalleryComments" resultType="com.edu.springboot.gallery.GalleryCommentDTO">
		    SELECT cm_id, user_id, cm_content, cm_postdate, rv_id, mt_id, ga_id
		    FROM comments
		    WHERE cm_id = #{cm_id}
		    ORDER BY cm_postdate DESC
		</select>
		
	</mapper>